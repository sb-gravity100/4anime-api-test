

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>4Anime Scraper API 4anime.ts</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
             
                <a href="index.html">
                    <h1 class="navbar-item">4Anime Scraper API</h1>
                </a>
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    API Documentation
                </a>
                
                 
                    
                        <a
                            class="link user-link "
                            href="https://github.com/sb-gravity100/4anime-api-test"
                        >
                            Repo
                        </a>
                    
                        <a
                            class="link user-link "
                            href="https://github.com/sb-gravity100"
                        >
                            Github
                        </a>
                    
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
                <div class="search-wrapper">
                    <input id="search" type="text" placeholder="Search docs..." class="input">
                </div>
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Classes</h3><ul><li><a href="FourAnime.html">FourAnime</a></li></ul><h3><a href="global.html">Global</a></h3></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>4anime.ts</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import axios from 'axios';
import { JSDOM } from 'jsdom';
import { EventEmitter } from 'events';
import { URL } from 'url';
import path from 'path';
import _ from 'lodash';
import { Aigle } from 'aigle';
import axiosRetry from 'axios-retry'

axiosRetry(axios, {
   retries: 3,
})

type AnimeStatus = 'Completed' | 'Currently Airing';
type AnimeType = 'Movie' | 'TV Series' | 'OVA' | 'Special' | 'ONA';

export interface SearchResult {
   title?: string;
   link: string;
   year?: string;
   status?: AnimeStatus;
}

export interface AnimeEpisode {
   src: string;
   ep: number;
   filename: string;
   id: number;
}

export interface AnimeData {
   title?: string;
   eps?: number;
   type?: AnimeType;
   status?: AnimeStatus;
   year?: string;
   data: Array&lt;AnimeEpisode>;
}

export interface AnimeOptions {
   catch?: boolean;
}
export interface $4Anime {
   term(
      s: string,
      cb: (s: Array&lt;SearchResult>) => void
   ): Promise&lt;Array&lt;SearchResult> | void>;
   episodes(
      a: SearchResult,
      cb?: (results: AnimeData | void) => void
   ): Promise&lt;AnimeData | void>;
}

/** 
 * Represents the class for getting links from 4Anime.to.
 * @class FourAnime - Represents the class for getting links from 4Anime.to.
 * @extends EventEmitter
 */
export class FourAnime extends EventEmitter implements $4Anime {
   /**
    * @private
    */
   private catch?: boolean;
   /** 
    * Creates a new FourAnime instance.
    * @param {Object} [FourAnimeOptions] - options.
    * @param {boolean} [FourAnimeOptions.catch] - throw all errors in a catch block if true. Otherwise it emits an error event.
    * @example
    * const Anime = new FourAnime({
    *    catch: false, // default
    * })
    */
   constructor(options?: AnimeOptions) {
      super({ captureRejections: true });
      this.catch = options.catch || false
   }
   /**
    * Callback for term.
    * @callback searchCallback
    * @param {object[] | void} SearchResult
    */

   /**
    * Search an anime by a term.
    * @param {string} s - string to search for.
    * @param {searchCallback} [cb] - optional callback.
    * @returns {object[] | void} An array of search results.
    * @example
    * Anime.term('jujutsu kaisen', results => {
    *   // Do something with it...
    * })
    */
   async term(
      s: string,
      cb: (s: Array&lt;SearchResult>) => void
   ): Promise&lt;Array&lt;SearchResult> | undefined> {
      let results: Array&lt;SearchResult>;
      try {
         const search = await axios.get('https://4anime.to', {
            method: 'GET',
            params: { s },
         });
         const { document } = new JSDOM(search.data).window;
         const _a: any = Array.from(
            document.querySelectorAll('div#headerDIV_95 a'),
            (a: any) => {
               const text = a.textContent
                  .trim()
                  .replace(/\/\n/gi, '')
                  .replace(/\/\n/gi, '')
                  .split('\n');
               text.splice(2, 1, a.href);
               const _r: any = _.zipObject(
                  ['title', 'year', 'link', 'status'],
                  text
               );
               if (_r.title.length > 75) {
                  _r.title += '...';
               }
               return _r;
            }
         );
         if (_a.length &lt; 1) {
            throw {
               name: 'Error',
               code: 'ANINOTFOUND',
               message: 'Anime not found',
            };
         }
         results = _a;
         if (cb) {
            cb(results);
         } else {
            return results;
         }
      } catch (e) {
         if (this.catch) {
            throw e;
         } else {
            this.emit('error', e);
            return;
         }
      }
   }

   /**
    * Callback for episodes.
    * @callback episodesCallback
    * @param {object | void} AnimeData
    */

   /**
    * Get anime data and episode links.
    * @param {object} a - an object from the search results.
    * @param {episodesCallback} [cb] - optional callback.
    * @returns {object[] | void} An array of search results.
    * @see FourAnime#term
    * @example
    * const search = await Anime.term('jujutsu kaisen')
    * Anime.episodes(search[0], results => {
    *   // Do something with the results...
    * })
    */
   async episodes(
      a: SearchResult,
      cb?: (results: AnimeData | void) => void
   ): Promise&lt;AnimeData | void> {
      let results: AnimeData;
      try {
         const anime = await axios({
            method: 'GET',
            url: a.link,
         });
         const { document } = new JSDOM(anime.data).window;
         const arr_href: Array&lt;URL> = Array.from(
            document.querySelectorAll('ul.episodes.range.active a'),
            (link: any) => new URL(link.href)
         );
         const type: AnimeType = document.querySelector('.details .detail a')
            .textContent;
         const title: string = document.querySelector('.single-anime-desktop')
            .textContent;
         const href_data = await this.hrefsData(arr_href);
         const all_data: AnimeData = {
            title: title,
            type: type,
            status: a.status,
            year: a.year,
            eps: arr_href.length,
            data: href_data,
         };
         if (type === 'Movie') {
            _.unset(all_data, 'eps')
         }
         results = all_data;
         if (cb) {
            cb(results);
         } else {
            return results;
         }
      } catch (e) {
         if (this.catch) {
            throw e;
         } else {
            this.emit('error', e);
            return;
         }
      }
   }

   private async hrefsData(
      href: Array&lt;URL>,
      cb?: (results: Array&lt;AnimeEpisode>) => void
   ): Promise&lt;Array&lt;AnimeEpisode>> {
      let results: Array&lt;AnimeEpisode>,
         qLength: number = 0;
      try {
         const async_handler = async (e: URL) => {
            const _anime = await axios.get(e.href);
            const { document } = new JSDOM(_anime.data).window;
            const ep: number = parseInt(e.pathname.split('-').pop()) || 1;
            const id: number = parseInt(e.searchParams.get('id'));
            const src: string = document.querySelector(
               'video#example_video_1 source'
            ).src;
            const filename = path.basename(src);
            qLength++;
            this.emit('loaded', qLength, href.length);
            return {
               ep,
               id,
               src,
               filename,
            };
         };
         const anime_data = await Aigle.resolve(href).map(async_handler);
         // .sortBy(d => d.ep);
         results = anime_data;
         if (cb) {
            cb(results);
         } else {
            return results;
         }
      } catch (e) {
         if (this.catch) {
            throw e;
         } else {
            this.emit('error', e);
            return;
         }
      }
   }
}
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Mon Apr 19 2021 04:42:51 GMT+0800 (China Standard Time)</p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by 
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>

<script src="scripts/search.js"> </script>

</body>
</html>
